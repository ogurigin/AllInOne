å‚è€ƒä¾‹å­ï¼š ğŸ‘‰ [**https://threejs.org/examples/games_fps.html**](https://threejs.org/examples/games_fps.html)

é¦–å…ˆåˆ›å»ºåœºæ™¯  `new THREE.Scene()`

ç›¸æœº`new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 100);`ï¼Œ

ç¯å¢ƒå…‰ç¯å…‰ `new THREE.AmbientLight('#ffffff', 2)`

ç‚¹å…‰æº `new THREE.PointLight('#ffffff', 7)`

è¾…åŠ©çº¿ï¼š `new THREE.AxesHelper(10);`   å¿…å¤‡

**å…·ä½“ç»†èŠ‚å…·ä½“åˆ†æ**

### æ¸²æŸ“å™¨

```js
const renderer = new THREE.WebGLRenderer({ 
	 antialias: false,//æ˜¯å¦æ‰§è¡ŒæŠ—é”¯é½¿ é»˜è®¤false
	 alpha: false//æ˜¯å¦å¼€å¯ é€æ˜åº¦ 
});
renderer.setPixelRatio(window.devicePixelRatio); //è®¾ç½®åƒç´ æ¯”ï¼Œä»¥å…åƒç´ ä¸åŒé€ æˆçš„æ¨¡ç³Š
renderer.setSize(window.innerWidth, window.innerHeight); //å…¨å±æ¸²æŸ“

renderer.toneMapping = THREE.ACESFilmicToneMapping; //ä¿®æ”¹æ¸²æŸ“å™¨çš„è‰²è°ƒæ˜ å°„æ¨¡å¼
// å…·ä½“å¯è§ https://threejs.org/docs/index.html#api/en/constants/Renderer
renderer.toneMappingExposure = 1;
//è®¾ç½®äº†æ¸²æŸ“å™¨çš„è‰²è°ƒæ˜ å°„æ›å…‰å€¼  HDR åœºæ™¯ä¸­è¢«è®¤ä¸ºæ˜¯â€œä¸­é—´è‰²è°ƒâ€çš„äº®åº¦ã€‚
document.body.appendChild(renderer.domElement); 
```

### å…¶ä»–ä¸€äº›åŸºç¡€çš„ å˜é‡

```js
const playerVelocity = new THREE.Vector3(); //è®°å½•ç©å®¶çš„ç§»åŠ¨é€Ÿåº¦
const playerDirection = new THREE.Vector3();//è®°å½•ç©å®¶çš„ç§»åŠ¨æ–¹å‘

const STEPS_PER_FRAME = 5; //æ£€æµ‹çš„é¢‘ç‡  æ¯ä¸€å¸§æ£€æµ‹çš„æ¬¡æ•°

//åˆ›å»ºç©å®¶çš„ èƒ¶å›Šä½“ï¼Œå‰é¢çš„ä¸¤ä¸ªä½ç½®å‚æ•° æ ¹æ®éœ€æ±‚
const playerCollider = new Capsule( new THREE.Vector3( 18, 1.5, 6 ), new THREE.Vector3(18,2.5, 6 ), 0.5 );
```

### æ§åˆ¶å™¨

è¯•äº†ä¸¤ç§ï¼Œ`FirstPersonControls` **ç¬¬ä¸€äººç§°æ§åˆ¶å™¨  å’Œ** `PointerLockControls`  **æŒ‡é’ˆé”å®šæ§åˆ¶å™¨**

ç¬¬ä¸€äººç§°ï¼šé¼ æ ‡å·¦å³æ§åˆ¶è§†è§’ï¼Œå¯ç›´æ¥ç‚¹å‡»ã€‚è‡ªåŠ¨wasd  ç§»åŠ¨è§†è§’ã€‚ é¼ æ ‡æ§åˆ¶æ–¹å¼ ä¸æ˜¯å¾ˆä¹ æƒ¯ã€‚

æŒ‡é’ˆé”å®šï¼šæ›´åƒ ç¬¬ä¸€äººç§°æ¸¸æˆçš„åˆ‡æ¢æ¨¡å¼ï¼Œä½†æ˜¯wasd æ§åˆ¶éœ€è¦è‡ªå·±è¾“å…¥ã€‚

ç„¶ååœ¨å®˜ç½‘æ‰¾åˆ°äº†åˆé€‚çš„ä¾‹å­ï¼Œ

https://threejs.org/examples/games_fps.html

**å…ˆè¯´è§†è§’æ§åˆ¶**ï¼š

```js
//éœ€è¦æƒ³æŠŠç›¸æœºçš„æ—‹è½¬é¡ºåº è®¾ä¸º YXZ
camera.rotation.order = 'YXZ';
//container ä¸º3dåŠ è½½çš„å®¹æ˜“
/* è¿™é‡Œç›‘å¬é¡µé¢æŒ‰ä¸‹é¼ æ ‡ï¼Œå¼€å§‹é”å®šå…‰æ ‡*/
container.addEventListener( 'mousedown', () => {
     document.body.requestPointerLock();
});
document.body.addEventListener( 'mousemove', ( event ) => {
      if ( document.pointerLockElement === document.body ) {
			//é¼ æ ‡æ°´å¹³ç§»åŠ¨çš„æ—¶å€™ æ§åˆ¶æ¨¡å‹ æ²¿ç€yè½´æ—‹è½¬  å‚ç›´åˆ™æ˜¯ æ²¿ç€xè½´æ—‹è½¬
          camera.rotation.y -= event.movementX / 500;
          camera.rotation.x -= event.movementY / 500;
      }
});
```

è¯•äº†ä¸‹ä»£ç ä¸éš¾ï¼Œå’Œä½¿ç”¨æŒ‡é’ˆé”å®šæ§åˆ¶å™¨çš„æ•ˆæœå·®ä¸å¤šï¼Œå¹¶å¯ä»¥è§£æ”¾å…‰æ ‡ï¼Œä¸å½±å“ç‚¹å‡»äº‹ä»¶ã€‚ 

æ¥ä¸‹æ¥æ˜¯ æŒ‰ä¸‹ `**WASD` ç§»åŠ¨**

```js
const keyStates  = {}; //åˆ›å»ºä¸€ä¸ªå¯¹è±¡ ç”¨äºè®°å½•æ•²ä¸‹çš„é”®
```

ä¸¤ä¸ªè·å–ç›¸æœº æ°´å¹³å‰åç§»åŠ¨æ–¹å‘çš„å‡½æ•°

```js
/* è·å– ç›¸æœºçš„å‰è¿›æˆ–è€…åé€€çš„å•ä½å‘é‡ */
const  getForwardVector = ()=>{
    /* è·å–ç›¸æœºæ­£è§†çš„æ–¹å‘ï¼Œå¹¶èµ‹å€¼ç»™ playerDirection*/
    camera.getWorldDirection( playerDirection );
    /* å‚ç›´æ–¹å‘ä¸åŠ¨ï¼Œ yç½®ä¸º0*/
    playerDirection.y = 0;
    /* è·å–è¿™ä¸ªæ–¹ä½çš„ å•ä½å‘é‡ */
    playerDirection.normalize();

    return playerDirection;
}
/* è·å– ç›¸æœºçš„å·¦å³çš„å•ä½å‘é‡ */
const getSideVector = ()=>{
    camera.getWorldDirection( playerDirection );
    playerDirection.y = 0;
    playerDirection.normalize();
    playerDirection.cross( camera.up );//å‰ç§¯  å‚ç›´äºä¸¤ä¸ªæ–¹å‘

    return playerDirection;
}
```

```js
	/*å®šä¹‰ç§»åŠ¨é€Ÿåº¦ï¼Œè·å–æ–¹å‘ å¹¶ä¹˜ä»¥é€Ÿåº¦ */
const controls = (deltaTime) =>{
    const speedDelta = deltaTime * 25; //å®šä¹‰ä¸€ä¸ªé€Ÿåº¦
    if ( keyStates[ 'KeyW' ] ) {
        playerVelocity.add( getForwardVector().multiplyScalar( speedDelta ) );
    }
    if ( keyStates[ 'KeyS' ] ) {
        playerVelocity.add( getForwardVector().multiplyScalar( -speedDelta ) );
    }
    if ( keyStates[ 'KeyD' ] ) {
        playerVelocity.add( getSideVector().multiplyScalar( speedDelta ) );
    }
    if ( keyStates[ 'KeyA' ] ) {
        playerVelocity.add( getSideVector().multiplyScalar( -speedDelta ) );
    }
}
```

æ›´æ–°ç©å®¶ä½ç½®

```js
const updatePlayer = ( deltaTime ) => {
    /* Math.exp() æ–¹æ³•ç”¨äºè®¡ç®—è‡ªç„¶å¯¹æ•°çš„åº•æ•° e çš„å¹‚
    è¯¥è¡¨è¾¾å¼è¡¨ç¤º ä¸€ä¸ªéšç€æ—¶é—´ï¼Œé€æ¸å‡å°‘çš„å€¼ 
    å¤§æ¦‚æ˜¯ä¸ºäº† æœ‰ä¸ªç¼“å†²è¿‡ç¨‹ï¼Œä¸ä¼šä¸€ä¸‹å­å˜0 */
    let damping = Math.exp( - 4 * deltaTime ) - 1;
    /* æ–¹å‘å‘é‡ + é€Ÿåº¦ * æ–¹å‘å‘é‡
    ? ç§»åŠ¨çš„è·ç¦»ï¼Ÿ */ 
    playerVelocity.addScaledVector( playerVelocity, damping );
	
    const deltaPosition = playerVelocity.clone().multiplyScalar( deltaTime );
    playerCollider.translate( deltaPosition );
    playerCollisions(); //é˜²æ’æµ‹è¯• 
    camera.position.copy( playerCollider.end );
}
```

### é˜²æ’æµ‹è¯•

ä¸Šæ–‡ä¸­çš„ `playerCollisions` æ–¹æ³•å°±æ˜¯æ£€æµ‹ç¢°æ’çš„ï¼Œ ä½†*ä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼Œç”¨å½“å‰å¯¼å…¥çš„æ¨¡å‹æ— æ•ˆï¼Œè€Œä¸” `OctreeHelper` ä¹Ÿä¸æ˜¾ç¤ºã€‚*

åŸºç¡€å†…å®¹

```js
const worldOctree = new Octree(); //åˆ›å»º å…«å‰æ ‘
/*éœ€è¦çš„è¯ å¯ä»¥åˆ›å»º */
//å¯¼å…¥æ¨¡å‹ 
const loader = new GLTFLoader();
    loader.load('../../../public/testDemo.glb', function (gltf) {
        const model = gltf.scene;
        // å°†å¯¼å…¥çš„ åœºæ™¯åŠ å…¥å…«å‰æ ‘
        worldOctree.fromGraphNode(model);
				... //çœç•¥å…¶ä»–ä»£ç 
    // å°†æ¨¡å‹æ·»åŠ åˆ°åœºæ™¯ä¸­
});
```

**`playerCollisions`** 

```js
const playerCollisions = () =>{
    // åˆ¤æ–­  æ˜¯å¦å­˜åœ¨ç›¸äº¤ 
    const result = worldOctree.capsuleIntersect(playerCollider);
    if ( result ) {
        // å¼¹å›
        playerCollider.translate( result.normal.multiplyScalar( result.depth ) );
				//æœ‰å‚ç›´æ–¹å‘çš„ç§»åŠ¨çš„æ—¶å€™ å¯ä»¥ç”¨è¿™ä¸ª ï¼Œæœ¬ä¾‹å­æš‚æ—¶ä¸è€ƒè™‘ 
        //playerVelocity.addScaledVector( result.normal, - result.normal.dot( playerVelocity ) );
    }
}
```

[ç¬¬ä¸€äººç§° æ¼«æ¸¸](https://www.notion.so/95bf8a61aaf745c1824aafaa463ff963?pvs=21)